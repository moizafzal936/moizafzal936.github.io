<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Distributed Job Orchestration Case Study — Mueez Afzal</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Crimson+Pro:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #0a0e14;
  --bg-elevated: #151920;
  --panel: #1a1f28;
  --panel-hover: #242933;
  --text: #e6e8eb;
  --text-muted: #8a8e98;
  --accent-primary: #00d4aa;
  --accent-secondary: #ff6b6b;
  --accent-tertiary: #ffd93d;
  --border: #2a2f3a;
  --code-bg: #0f1419;

  --font-display: 'JetBrains Mono', monospace;
  --font-body: 'Crimson Pro', serif;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: var(--font-body);
  background: var(--bg);
  color: var(--text);
  line-height: 1.8;
  font-size: 18px;
}

.container {
  max-width: 900px;
  margin: 0 auto;
  padding: 60px 30px;
}

.back-link {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-family: var(--font-display);
  font-size: 0.9rem;
  color: var(--accent-primary);
  text-decoration: none;
  margin-bottom: 40px;
  transition: gap 0.3s ease;
}

.back-link:hover {
  gap: 12px;
}

.hero {
  margin-bottom: 60px;
  padding-bottom: 40px;
  border-bottom: 1px solid var(--border);
}

.case-title {
  font-family: var(--font-display);
  font-size: clamp(2rem, 5vw, 3rem);
  font-weight: 700;
  margin-bottom: 16px;
  line-height: 1.2;
  color: var(--accent-primary);
}

.case-subtitle {
  font-size: 1.3rem;
  color: var(--text-muted);
  margin-bottom: 30px;
}

.metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 24px;
  margin-top: 40px;
}

.metric-box {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  text-align: center;
}

.metric-value {
  font-family: var(--font-display);
  font-size: 2.5rem;
  font-weight: 700;
  color: var(--accent-primary);
  display: block;
  margin-bottom: 8px;
}

.metric-value.negative {
  color: var(--accent-secondary);
}

.metric-value.business {
  color: var(--accent-tertiary);
}

.metric-label {
  font-size: 0.9rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.section {
  margin-bottom: 60px;
}

.section-title {
  font-family: var(--font-display);
  font-size: 1.8rem;
  font-weight: 700;
  margin-bottom: 24px;
  color: var(--accent-primary);
}

.section-content {
  color: var(--text);
  line-height: 1.8;
}

.section-content p {
  margin-bottom: 20px;
}

.section-content strong {
  color: var(--accent-primary);
  font-weight: 600;
}

.section-content em {
  color: var(--accent-secondary);
  font-style: normal;
}

.highlight-box {
  background: var(--panel);
  border-left: 4px solid var(--accent-primary);
  padding: 24px;
  margin: 30px 0;
  border-radius: 8px;
}

.code-block {
  background: var(--code-bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 24px;
  margin: 30px 0;
  overflow-x: auto;
  font-family: var(--font-display);
  font-size: 0.9rem;
  line-height: 1.6;
  color: var(--text);
}

.code-block code {
  color: var(--text-muted);
}

.code-block .keyword {
  color: #ff6b6b;
}

.code-block .string {
  color: #00d4aa;
}

.code-block .comment {
  color: #64748b;
}

ul {
  margin: 20px 0;
  padding-left: 24px;
}

li {
  margin-bottom: 12px;
  color: var(--text-muted);
}

li strong {
  color: var(--text);
}

.state-diagram {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 40px;
  margin: 40px 0;
  text-align: center;
  font-family: var(--font-display);
  font-size: 0.9rem;
}

.lessons-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 24px;
  margin-top: 30px;
}

.lesson-card {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
}

.lesson-title {
  font-family: var(--font-display);
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--accent-primary);
  margin-bottom: 12px;
}

.lesson-content {
  font-size: 0.95rem;
  color: var(--text-muted);
  line-height: 1.6;
}

@media (max-width: 640px) {
  .case-title {
    font-size: 1.8rem;
  }

  .section-title {
    font-size: 1.4rem;
  }

  .metrics-grid {
    grid-template-columns: 1fr;
  }
}
</style>
</head>

<body>
<div class="container">
  <a href="../index.html" class="back-link">← Back to Portfolio</a>

  <div class="hero">
    <h1 class="case-title">Distributed Job Orchestration</h1>
    <p class="case-subtitle">
      Redesigning payroll processing with state machines, failure replay, and visibility
    </p>

    <div class="metrics-grid">
      <div class="metric-box">
        <span class="metric-value">120K+</span>
        <span class="metric-label">Jobs / Month</span>
      </div>
      <div class="metric-box">
        <span class="metric-value negative">100%</span>
        <span class="metric-label">Silent Failures Eliminated</span>
      </div>
      <div class="metric-box">
        <span class="metric-value">8min</span>
        <span class="metric-label">Avg Recovery Time</span>
      </div>
      <div class="metric-box">
        <span class="metric-value">99.94%</span>
        <span class="metric-label">Success Rate</span>
      </div>
    </div>
  </div>

  <!-- PROBLEM -->
  <div class="section">
    <h2 class="section-title">The Problem</h2>
    <div class="section-content">
      <p>
        Our SaaS platform runs a complex payroll processing pipeline for 500+ companies. Every month, we orchestrate
        <strong>120,000+ background jobs</strong> to calculate payroll, generate tax forms, process direct deposits,
        and send notifications.
      </p>

      <p>
        <em>It was falling apart:</em>
      </p>

      <ul>
        <li><strong>Silent failures:</strong> Jobs failing without alerting anyone. Payroll calculations completing with incorrect data.</li>
        <li><strong>No visibility:</strong> When a job failed, we had no way to know which step broke or what data was affected</li>
        <li><strong>Manual recovery:</strong> Engineers spending 10+ hours/week manually replaying failed jobs from logs</li>
        <li><strong>Cascading failures:</strong> When one job failed (e.g., tax calculation), downstream jobs (direct deposit) would silently succeed with incorrect data</li>
        <li><strong>No retry strategy:</strong> Transient failures (API timeouts, rate limits) caused permanent job failures</li>
      </ul>

      <div class="highlight-box">
        <p style="margin: 0;">
          <strong>The incident:</strong> A third-party tax API had a 2-hour outage. 400+ payroll runs silently failed.
          We didn't discover it until customers complained they hadn't received paychecks.
          Took 18 engineer-hours to manually identify and replay affected jobs.
        </p>
      </div>

      <p>
        The root issue: we were treating Sidekiq jobs as fire-and-forget. No state tracking. No failure boundaries.
        No way to replay or audit what happened.
      </p>
    </div>
  </div>

  <!-- CONSTRAINTS -->
  <div class="section">
    <h2 class="section-title">Constraints & Challenges</h2>
    <div class="section-content">
      <p>
        This was critical infrastructure powering real people's paychecks. We couldn't afford downtime or data corruption.
      </p>

      <ul>
        <li><strong>Production traffic:</strong> 120K+ jobs/month can't be paused for migration</li>
        <li><strong>Data integrity:</strong> Payroll calculations must be accurate and auditable</li>
        <li><strong>Third-party dependencies:</strong> External APIs (banks, tax services) have SLAs we don't control</li>
        <li><strong>Compliance:</strong> SOC 2 audit requirements for job execution logs and failure handling</li>
        <li><strong>Team bandwidth:</strong> Led implementation with 1 junior engineer while maintaining feature velocity</li>
        <li><strong>Legacy complexity:</strong> 47 different job types across 8 queues with varying criticality</li>
      </ul>

      <p>
        We needed a solution that could be incrementally adopted without rewriting every job.
      </p>
    </div>
  </div>

  <!-- SOLUTION -->
  <div class="section">
    <h2 class="section-title">Architecture & Solution</h2>
    <div class="section-content">
      <p>
        I designed a <strong>state machine-based job orchestration system</strong> with three core principles:
        explicit state tracking, automatic failure recovery, and complete audit trails.
      </p>

      <h3 style="font-size: 1.3rem; margin: 30px 0 16px; color: var(--accent-primary);">
        Core 1: Job State Machines
      </h3>

      <p>
        Every critical job now tracks its lifecycle through explicit states. No more guessing if a job succeeded or silently failed.
      </p>

      <div class="state-diagram">
        <p style="margin-bottom: 20px; color: var(--text-muted);">Job State Transitions:</p>
        <p style="color: var(--accent-primary);">
          PENDING → RUNNING → COMPLETED<br/>
          &nbsp;&nbsp;&nbsp;&nbsp;↓<br/>
          &nbsp;&nbsp;&nbsp;&nbsp;FAILED → RETRY → RUNNING<br/>
          &nbsp;&nbsp;&nbsp;&nbsp;↓<br/>
          &nbsp;&nbsp;&nbsp;&nbsp;DEAD (after max retries)
        </p>
      </div>

      <div class="code-block">
<code><span class="comment"># State machine pattern for jobs</span>
<span class="keyword">class</span> PayrollCalculationJob &lt; ApplicationJob
  include StateMachine

  states :pending, :running, :completed, :failed, :retry, :dead

  <span class="keyword">def</span> <span class="function">perform</span>(payroll_run_id)
    transition_to!(:running)

    payroll = PayrollRun.find(payroll_run_id)
    result = calculate_payroll(payroll)

    transition_to!(:completed, result: result)
  <span class="keyword">rescue</span> => error
    handle_failure(error)
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function">handle_failure</span>(error)
    <span class="keyword">if</span> retriable_error?(error) && attempts < max_retries
      transition_to!(:retry)
      retry_in = exponential_backoff(attempts)
      self.class.set(wait: retry_in).perform_later(arguments)
    <span class="keyword">else</span>
      transition_to!(:dead, error: error.message)
      notify_oncall(<span class="string">"Job permanently failed: #{error}"</span>)
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span></code>
      </div>

      <p>
        State transitions are stored in a <code>job_executions</code> table with full audit trail:
        timestamps, error messages, retry counts, and data snapshots.
      </p>

      <h3 style="font-size: 1.3rem; margin: 30px 0 16px; color: var(--accent-primary);">
        Core 2: Intelligent Retry Strategies
      </h3>

      <p>
        Not all failures are equal. We classify errors and handle them differently:
      </p>

      <ul>
        <li><strong>Retriable errors:</strong> API timeouts, rate limits, network glitches → Exponential backoff with jitter (1min, 5min, 30min, 2hr)</li>
        <li><strong>Fatal errors:</strong> Invalid data, business logic violations → Mark as DEAD, alert engineers immediately</li>
        <li><strong>Dependency failures:</strong> Third-party service down → Circuit breaker pattern, queue for later replay</li>
      </ul>

      <div class="code-block">
<code><span class="keyword">def</span> <span class="function">retriable_error?</span>(error)
  <span class="keyword">case</span> error
  <span class="keyword">when</span> Timeout::Error, Net::ReadTimeout
    <span class="keyword">true</span>
  <span class="keyword">when</span> APIRateLimitError
    <span class="keyword">true</span>
  <span class="keyword">when</span> DataValidationError, BusinessLogicError
    <span class="keyword">false</span> <span class="comment"># Don't retry - needs human intervention</span>
  <span class="keyword">else</span>
    <span class="keyword">false</span> <span class="comment"># Unknown errors are fatal by default</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">def</span> <span class="function">exponential_backoff</span>(attempt)
  base_delay = 1.minute
  max_delay = 2.hours
  jitter = rand(0..30).seconds

  delay = [base_delay * (2 ** attempt), max_delay].min
  delay + jitter
<span class="keyword">end</span></code>
      </div>

      <p>
        Jitter prevents thundering herd when bulk jobs retry simultaneously after a service outage.
      </p>

      <h3 style="font-size: 1.3rem; margin: 30px 0 16px; color: var(--accent-primary);">
        Core 3: Dead Queue Dashboard & Replay
      </h3>

      <p>
        We built a custom Sidekiq UI extension showing all jobs in DEAD state with one-click replay functionality:
      </p>

      <ul>
        <li>Filter by job type, date range, error type</li>
        <li>Bulk replay with rate limiting (prevent overloading downstream services)</li>
        <li>Preview affected data before replay (catch bad data early)</li>
        <li>Audit log of who replayed what and when (SOC 2 compliance)</li>
      </ul>

      <p>
        This turned an 18-hour manual recovery process into a 10-minute dashboard operation.
      </p>
    </div>
  </div>

  <!-- IMPLEMENTATION -->
  <div class="section">
    <h2 class="section-title">Implementation Details</h2>
    <div class="section-content">
      <h3 style="font-size: 1.3rem; margin: 30px 0 16px; color: var(--accent-primary);">
        Incremental Adoption
      </h3>

      <p>
        We couldn't rewrite 47 job types at once. We prioritized by business impact:
      </p>

      <p><strong>Phase 1 (Week 1-2):</strong> Payroll calculation jobs (highest risk, 40K jobs/month)</p>
      <p><strong>Phase 2 (Week 3-4):</strong> Direct deposit processing (second highest risk, 35K jobs/month)</p>
      <p><strong>Phase 3 (Week 5-8):</strong> Tax form generation, notifications, reporting (remaining 45K jobs/month)</p>

      <p>
        Each phase: build state machine wrapper → shadow mode testing → production rollout → monitoring.
      </p>

      <h3 style="font-size: 1.3rem; margin: 30px 0 16px; color: var(--accent-primary);">
        Monitoring & Alerting
      </h3>

      <p>
        We instrument every state transition:
      </p>

      <ul>
        <li><strong>Success rate by job type:</strong> Alert if any job type drops below 99.5% success</li>
        <li><strong>Dead queue size:</strong> Alert if >10 jobs in DEAD state for critical job types</li>
        <li><strong>Retry patterns:</strong> Dashboard showing which errors trigger most retries (helps identify flaky dependencies)</li>
        <li><strong>Processing time trends:</strong> Catch performance degradation before it becomes a problem</li>
        <li><strong>Business metrics:</strong> Track on-time payroll delivery % (our actual SLO)</li>
      </ul>

      <p>
        Alerts go to Slack with direct links to affected jobs in the replay dashboard.
      </p>
    </div>
  </div>

  <!-- RESULTS -->
  <div class="section">
    <h2 class="section-title">Results & Impact</h2>
    <div class="section-content">
      <p>
        <strong>4 months post-launch:</strong>
      </p>

      <ul>
        <li><strong>100% elimination of silent failures</strong> (every failure now tracked and alertable)</li>
        <li><strong>99.94% job success rate</strong> (up from 97.8% before state machines)</li>
        <li><strong>8min average recovery time</strong> (down from 18 hours manual recovery)</li>
        <li><strong>10+ engineer-hours/week saved</strong> on manual job replay operations</li>
        <li><strong>Zero payroll delivery delays</strong> since deployment (previously 3-4/month)</li>
        <li><strong>SOC 2 audit requirement met</strong> with complete job execution audit trails</li>
      </ul>

      <div class="highlight-box">
        <p style="margin: 0;">
          <strong>The test:</strong> When the same third-party tax API went down again (3-hour outage this time),
          our circuit breakers caught it in real-time, jobs automatically queued for replay, and
          we recovered within 12 minutes once the API came back online. Zero customer complaints.
        </p>
      </div>

      <p>
        <strong>Business impact:</strong> Payroll reliability became a competitive differentiator in sales calls.
        We now highlight our job orchestration architecture in enterprise demos.
      </p>
    </div>
  </div>

  <!-- LESSONS LEARNED -->
  <div class="section">
    <h2 class="section-title">Lessons Learned</h2>
    <div class="lessons-grid">
      <div class="lesson-card">
        <h3 class="lesson-title">State Machines > Hope</h3>
        <p class="lesson-content">
          Fire-and-forget jobs are a ticking time bomb. Explicit state tracking turns invisible failures into actionable alerts.
        </p>
      </div>

      <div class="lesson-card">
        <h3 class="lesson-title">Classify Errors</h3>
        <p class="lesson-content">
          Not all failures should retry. Transient errors need backoff. Fatal errors need humans.
          Know the difference.
        </p>
      </div>

      <div class="lesson-card">
        <h3 class="lesson-title">Jitter Saves Lives</h3>
        <p class="lesson-content">
          When a service recovers from an outage, synchronized retries create a thundering herd.
          Add random jitter to spread the load.
        </p>
      </div>

      <div class="lesson-card">
        <h3 class="lesson-title">Dashboards > Logs</h3>
        <p class="lesson-content">
          Grepping logs at 3 AM is hell. A dead queue dashboard with one-click replay
          turns incidents into 10-minute fixes.
        </p>
      </div>

      <div class="lesson-card">
        <h3 class="lesson-title">Audit Everything</h3>
        <p class="lesson-content">
          When money is involved (payroll), you need complete audit trails.
          Who ran what, when, and what was the result. SOC 2 will thank you.
        </p>
      </div>

      <div class="lesson-card">
        <h3 class="lesson-title">Incremental Wins</h3>
        <p class="lesson-content">
          Migrating 47 job types at once would've failed.
          Prioritize by business impact, ship incrementally, learn fast.
        </p>
      </div>
    </div>
  </div>

  <div style="margin-top: 80px; padding-top: 40px; border-top: 1px solid var(--border); text-align: center;">
    <a href="../index.html" class="back-link" style="margin: 0;">← Back to Portfolio</a>
  </div>
</div>
</body>
</html>
